# 笔刷功能 — 实现计划 (V4, 已落地更新)

## 0. 当前实现状态（2026-02-20，按 `brush-example.ts` 思路落地）

> 若与下文规划描述有冲突，以本节“已落地状态”为准。

### 0.1 已落地改动
- 2D 预览布尔改为“圆刷/胶囊刷逐段 stamp + Clipper2 布尔”：
  - 单点轨迹生成圆刷 polygon。
  - 多点轨迹按相邻点生成胶囊 polygon，并逐段执行 `Union/Difference`。
- `brushContourPoints` 默认固定为 `40`（兼容旧参数 `arcSteps`，但优先使用 `brushContourPoints`）。
- `erase` 语义修正为“面差集优先”：
  - 闭环轮廓走 `AddSubject + Difference`（得到减去笔刷后的闭合边界）。
  - 开放线段走 `AddOpenSubject + Difference`。
  - 结果合并闭环与开口输出，避免仅出现“边被剪断”的视觉问题。
- 去除 fallback（严格模式）：
  - `DefaultBrushEngine2D` 必须提供 `clipperAdapter`，缺失直接报错。
  - Clipper `ExecutePath` 失败直接抛错，不再静默退化。
  - Demo 不再回退 `SliceRenderer` 或 TS 布尔实现。
- 预览性能修复：
  - `BrushSession.appendPoint` 首帧后改为增量预览（只处理最新两点 + 上次 `nextSegments`）。
  - no-op 点（未通过最小距离）跳过预览计算。
- 状态机修复：
  - `invalidated` 状态下，`setBaseSegments` 后会自动回到 `idle`，切视角/改 anchor 后可继续勾画。

### 0.2 关键代码位置
- `src/core/brush/brush-engine-2d.ts`
- `src/core/brush/clipper2-wasm-adapter.ts`
- `src/core/brush/brush-session.ts`
- `src/demo/main.ts`
- `src/core/__tests__/brush-engine-2d.test.ts`
- `src/core/__tests__/brush-session.test.ts`

### 0.3 本期明确不做
- `removeHoles`
- MPR 每页交点矩形增量 union/cut 方案
- 层间插值、扩张收缩、external ROI 创建（后端算法）

## 1. 目标、范围与非目标

### 1.1 目标
在当前 MPR/切面视图中选定一个 `activeMesh`，通过笔刷完成实时布尔编辑：
- `Add`：涂抹增加。
- `Erase`：涂抹减少。

交互分两段：
- 预览阶段（`mousemove`）：只做 2D 几何预览，保证流畅。
- 提交阶段（`mouseup`）：将本次轨迹提交为 3D 布尔并刷新多视图。

### 1.2 范围
- 单次只编辑一个 `activeMesh`。
- 笔刷精度目标 `0.1mm`，最大半径 `50mm`。
- 预览真相源是当前切面的 `activeSegments2D`。
- 提交真相源是 3D 布尔后的新网格。

### 1.3 非目标（本期不做）
- 多 mesh 同时笔刷。
- 压感/硬度/纹理笔刷。
- 体素化布尔路径。

---

## 2. 性能目标与验收基线

### 2.1 性能目标
| 阶段 | 触发 | 行为 | 目标 |
|------|------|------|------|
| 预览 | `mousemove` | 刷新笔刷轨迹与 activeMesh 切面 2D 布尔结果 | `p95 < 30ms`，`p99 < 40ms` |
| 提交 | `mouseup` | 2D 轨迹转 3D 胶囊体并执行网格布尔 | `p95 < 500ms`，`p99 < 700ms` |

### 2.2 验收基线（统一口径）
性能结论必须在以下固定基线下给出：
- 机器：Apple M1 Pro / 16GB（或同级别 x86 独显机，需在报告中注明）。
- 浏览器：Chrome Stable（记录精确版本号）。
- 构建：`npm run build && npm run preview`（非 dev 热更新环境）。
- 数据规模：
  - `activeMesh` 三角面数 `80k ~ 200k`。
  - 当前切面 `activeSegments2D` 条数 `1k ~ 6k`。
  - 单次笔画轨迹点数 `100 ~ 800`。
  - 笔刷半径 `1mm ~ 50mm`。
- 运行口径：
  - 预热 10 次后采样 200 帧。
  - 提交阶段采样 50 次，分别统计冷启动（首次加载 Wasm）与热启动。

### 2.3 验收标准
- 达到 2.1 的 p95 目标，且无可见掉帧连片（连续 5 帧以上 > 40ms 视为失败）。
- 提交后无拓扑破洞、自交或明显“纸片/梯田”伪影。
- 跨视图同步后，任意视图重切片结果与新网格一致。

---

## 3. 核心架构决策

1. 渲染分层：`BgBitmap + ActiveSegments + UI Overlay`
- Layer 0：`bgBitmap`（排除 activeMesh 后缓存位图）。
- Layer 1：`activeSegments2D`（WebGPU 动态线段渲染）。
- Layer 2：Canvas2D 交互 UI（光标、轨迹提示）。

2. 2D 预览布尔：`Clipper2-WASM`
- 使用本地圆刷/胶囊刷构造（固定点数）生成笔刷多边形。
- 对笔刷 stamp 逐段执行 `Union/Difference` 做预览几何更新。

3. 3D 提交布尔：`Manifold3D-WASM`
- 将 2D 轨迹映射为 3D 胶囊体（sphere sweep/capsule mesh）。
- 与 `activeMesh` 执行 3D 布尔，得到拓扑稳定的新网格。

4. 不使用空间索引（本次明确约束）
- 不引入 `QuadTree/R-Tree/rbush`。
- 预览阶段采用“顺序扫描 + AABB 粗筛 + ROI 布尔”的确定性流程。
- 先保证正确性与一致性，再根据实测决定是否进入后续优化版本。

---

## 4. 几何与数据契约（新增，强约束）

### 4.1 坐标约定
- `activeSegments2D`、`brushStroke2D`、`brushPolygon2D` 统一使用当前切面局部坐标（单位：`mm`）。
- 渲染时才进行 `mm -> pixel` 变换。
- Clipper2 输入使用统一缩放系数 `CLIPPER_SCALE`（建议 `1000`，即 1e-3 mm 精度）。

### 4.2 核心类型（草案）
```ts
export type BrushMode = 'add' | 'erase'

export interface Vec2 {
  x: number // mm
  y: number // mm
}

export interface Segment2D {
  a: Vec2
  b: Vec2
}

export interface BrushStroke {
  points: Vec2[]          // 原始轨迹（mm）
  simplified: Vec2[]      // DP 简化后轨迹（mm）
  radiusMm: number
  mode: BrushMode
}

export interface PreviewInput {
  baseSegments: Segment2D[]   // 当前预览真相源
  strokePoints: Vec2[]
  radiusMm: number
  mode: BrushMode
}

export interface PreviewOutput {
  nextSegments: Segment2D[]
  dirtyBoundsMm: { minX: number; minY: number; maxX: number; maxY: number }
  stats: { segmentCount: number; elapsedMs: number }
}

export interface CommitInput {
  meshId: string
  stroke: BrushStroke
  slicePlane: { normal: [number, number, number]; anchor: [number, number, number] }
}

export interface CommitOutput {
  newMeshId: string
  triangleCount: number
  elapsedMs: number
}
```

### 4.3 2D 布尔 I/O 契约（重点）
`BrushEngine2D.preview(input)` 必须遵循以下流程：
1. `strokePoints -> DP simplify`（阈值 `epsilonMm`）。
2. `simplified -> brushStamps`：
- 单点：圆刷 polygon。
- 多点：按相邻点构造胶囊 polygon（逐段）。
3. 逐段布尔：
- `add`: 对每个 stamp 执行 `Union`。
- `erase`: 对每个 stamp 执行 `Difference`。
4. Clipper 输入拆分：
- 闭环走 `AddSubject`（面语义）。
- 开口走 `AddOpenSubject`（线语义）。
5. `clipper output -> Segment2D[]`：
- 去重（端点 epsilon 合并）。
- 零长度段剔除。
- 共线短段合并（可选，受阈值控制）。
6. 输出 `PreviewOutput`，作为下一帧 `baseSegments`。

约束：
- 单帧预览函数纯函数化，不可直接读写全局渲染状态。
- 输出顺序稳定（同输入同输出顺序），保证可回放调试。

### 4.4 3D 提交 I/O 契约
`BrushEngine3D.commit(input)`：
1. 把 `stroke.simplified` 反投影到切面 3D。
2. 生成胶囊体网格（半径与分段精度由统一参数驱动）。
3. 调用 Manifold 布尔：
- `add`: `activeMesh ∪ capsule`
- `erase`: `activeMesh - capsule`
4. 返回 `CommitOutput` 与新网格句柄；失败时返回明确错误码。

---

## 5. 状态机与并发策略（新增）

### 5.1 状态定义
- `idle`：无笔画。
- `drawing`：采集轨迹并做实时 2D 预览。
- `committing`：3D 提交中（WASM 布尔）。
- `invalidated`：当前缓存与相机/切面不一致，等待重切片。

### 5.2 状态转移表
| 事件 | 当前状态 | 下一状态 | 约束/动作 |
|------|----------|----------|----------|
| `selectActiveMesh` | any | `idle` | 重新 `sliceBatch(activeMesh)`，重建 `activeSegments2D` |
| `mousedown` | `idle` | `drawing` | 锁定视图导航；初始化 stroke buffer |
| `mousemove` | `drawing` | `drawing` | 调 `BrushEngine2D.preview`，刷新 Line Buffer |
| `mouseup` | `drawing` | `committing` | 冻结最后预览结果，异步触发 3D commit |
| `commitSuccess` | `committing` | `idle` | 更新 mesh；通知其他视图重切片；当前视图保留预览结果直到失效 |
| `commitFail` | `committing` | `idle` | 回退到提交前快照，记录错误 |
| `cameraRotate/anchorScroll` | `idle` | `invalidated` | 标记当前切面缓存失效 |
| `resliceDone` | `invalidated` | `idle` | 用新切面 `activeSegments2D` 替换缓存（`setBaseSegments` 自动恢复到 `idle`） |
| `cancel` | `drawing` | `idle` | 丢弃本次笔画，恢复会话前段集 |

### 5.3 并发约束
- 预览：只保留最新一帧（latest-wins），丢弃过期计算结果。
- 提交：单飞（single-flight），`committing` 期间不允许新提交。
- 导航：`drawing` 期间禁用切面滚动与旋转。

---

## 6. `sliceBatch` 生命周期（修订）

`sliceBatch` 在 V3 中仍是 3D 到 2D 的唯一降维入口，但触发时机严格受控。

| 触发场景 | 触发时机 | 动作 |
|------|------|------|
| 会话初始化 | 选中 `activeMesh` | 执行 `sliceBatch` 生成 `activeSegments2D` 并渲染初始激活层 |
| 视图改变 | `normal/anchor` 改变且当前非 `drawing` | 重新 `sliceBatch` 并替换缓存 |
| 提交完成后 | `commitSuccess` | 当前视图不立即重切片（无闪烁连绘）；其他视图按事件重切片 |
| 预览中 | 每帧 `mousemove` | 禁止触发 `sliceBatch`，仅走 2D 引擎 |

补充说明：
- 当前视图缓存仅在 `cameraRotate`、`anchorScroll`、`activeMesh` 切换时失效。
- 该策略保证“连绘无跳帧”优先，随后再通过失效重切片与 3D 真相对齐。

---

## 7. 预览与提交执行流程（去空间索引版）

### 7.1 预览（每帧 `mousemove`）
```text
1) 采集轨迹点并做 DP 简化
2) 生成笔刷 stamp（圆刷或胶囊）
3) 逐 stamp 执行 Clipper `Union/Difference`
4) 输出 `nextSegments` 并做去重/零长剔除
5) 刷新 Line Buffer 与 overlay
```

说明：
- 不使用任何空间索引结构。
- 预览采用增量策略：首帧后仅处理“最新两点 + 上帧结果”。

### 7.2 提交（`mouseup`）
```text
1) 保持最后一帧预览显示
2) 冻结 stroke.simplified + 参数
3) 异步执行 BrushEngine3D.commit
4) 成功：更新 activeMesh GPU/CPU 缓冲，广播其他视图重切片
5) 失败：回滚到提交前 2D 快照并提示错误
```

---

## 8. 模块拆分与 API 设计（新增）

### 8.1 依赖
- `Clipper2-WASM`：2D 膨胀与布尔。
- `manifold`（WASM npm 包）：3D 网格布尔。

### 8.2 目录
```text
src/
├── core/
│   ├── brush/
│   │   ├── brush-types.ts
│   │   ├── brush-stroke.ts
│   │   ├── brush-engine-2d.ts
│   │   ├── brush-engine-3d.ts
│   │   └── brush-session.ts
│   └── gpu/
│       └── webgpu-line-renderer.ts
├── renderer/
│   ├── brush-overlay-renderer.ts
│   └── multi-view-manager.ts
```

### 8.3 关键接口签名（草案）
```ts
// brush-engine-2d.ts
export interface BrushEngine2D {
  preview(input: PreviewInput): PreviewOutput
}

// brush-engine-3d.ts
export interface BrushEngine3D {
  commit(input: CommitInput): Promise<CommitOutput>
}

// brush-session.ts
export interface BrushSession {
  beginStroke(point: Vec2, radiusMm: number, mode: BrushMode): void
  appendPoint(point: Vec2): PreviewOutput | null
  endStroke(): Promise<CommitOutput>
  cancelStroke(): void
  invalidate(reason: 'cameraRotate' | 'anchorScroll' | 'meshChanged'): void
  resliceIfNeeded(): Promise<void>
}

// webgpu-line-renderer.ts
export interface WebGPULineRenderer {
  setSegments(segments: Segment2D[]): void
  render(): void
  dispose(): void
}
```

---

## 9. 里程碑与交付物

### M1: 最小闭环（2D 预览）
- 完成 `brush-session`、`brush-engine-2d`、`webgpu-line-renderer` 基础接线。
- 能在单视图中稳定 `add/erase` 预览。

### M2: 3D 提交闭环
- 接入 `brush-engine-3d` + `Manifold3D`。
- `mouseup` 后正确更新 `activeMesh` 并同步多视图。

### M3: 性能与稳定性
- 达成第 2 节验收基线。
- 完成异常网格与失败回滚链路。

---

## 10. 验收清单（新增）

### 10.1 功能正确性
- `add/erase` 在单次短笔画、长笔画、重复覆盖下结果正确。
- `commitSuccess` 后多视图切面一致。
- `commitFail` 可回滚且界面无残留脏状态。

### 10.2 性能
- 预览帧：满足 `p95 < 30ms`。
- 提交：满足 `p95 < 500ms`（冷/热启动分开报告）。

### 10.3 稳定性
- 连续 100 次笔画无崩溃。
- 无内存持续增长（Wasm 对象与 GPU Buffer 正常释放）。
- 控制台无新增 error。

### 10.4 测试与证据
- 单测：
  - `brush-engine-2d` 的路径膨胀、布尔与退化输入处理。
  - `brush-session` 状态机转移与并发约束。
- 集成测试：
  - 从 `mousedown -> mousemove -> mouseup -> commit` 全链路。
- 产出：
  - 性能报告（含机器/浏览器版本）。
  - 关键场景截图或录屏。

---

## 11. 任务列表（可执行）

### 11.0 当前完成进度（与本仓库代码同步）
- [x] `brush-engine-2d`：圆刷/胶囊刷逐段布尔已落地（无 fallback）。
- [x] `clipper2-wasm-adapter`：erase 支持闭环面差集 + 开口线差集。
- [x] `brush-session`：增量预览与 `invalidated -> idle` 恢复已落地。
- [x] Demo：去除渲染与布尔 fallback，仅保留 WebGPU + Clipper2 路径。
- [x] 单测：`brush-engine-2d`、`brush-session`、`brush-e2e-flow` 已覆盖关键回归。

### M1（2D 预览最小闭环）
- [ ] T1 定义笔刷域类型与常量：新增 `src/core/brush/brush-types.ts`，包含 `BrushMode/Segment2D/PreviewInput/PreviewOutput/CLIPPER_SCALE`。完成标准：类型无歧义，`npm test` 通过。
- [ ] T2 实现轨迹采集与简化：新增 `src/core/brush/brush-stroke.ts`，实现点采样、最小间距过滤、DP 简化。完成标准：对重复点/短线/急转角有稳定输出。
- [ ] T3 接入 Clipper2 基础封装：新增 `src/core/brush/brush-engine-2d.ts` 的 Wasm 初始化与路径转换。完成标准：可将 `Segment2D[]` 与笔刷轨迹转换为 Clipper 输入。
- [ ] T4 实现 `preview()` 主流程：完成 Inflate + Union/Difference + 结果段去重与零长剔除。完成标准：`add/erase` 结果可回放且同输入同输出顺序稳定。
- [ ] T5 补 2D 引擎单测：新增 `src/core/__tests__/brush-engine-2d.test.ts`。完成标准：覆盖正常路径、退化输入、边界半径与顺序稳定性。

### M2（渲染与状态机闭环）
- [ ] T6 实现动态线段渲染器：新增 `src/core/gpu/webgpu-line-renderer.ts`，提供 `setSegments/render/dispose`。完成标准：可稳定渲染 `activeSegments2D`，无明显锯齿回退。
- [ ] T7 实现分层合成调度：新增 `src/renderer/brush-overlay-renderer.ts`，按 `bgBitmap + activeSegments + UI` 合成。完成标准：预览与静态显示无闪烁切换。
- [ ] T8 实现会话状态机：新增 `src/core/brush/brush-session.ts`，覆盖 `idle/drawing/committing/invalidated` 与事件转移。完成标准：状态转移符合第 5 节表格定义。
- [ ] T9 接入交互事件：在 `src/renderer/slice-renderer.ts` 与 demo 入口接入 `mousedown/mousemove/mouseup`，`drawing` 期间锁导航。完成标准：操作期间不会触发切面滚动或旋转。
- [ ] T10 补状态机与集成测试：新增 `src/core/__tests__/brush-session.test.ts`。完成标准：覆盖 latest-wins、single-flight、cancel、commitFail 回滚。

### M3（3D 提交与多视图）
- [ ] T11 接入 Manifold3D 封装：新增 `src/core/brush/brush-engine-3d.ts`，实现 Wasm 生命周期管理。完成标准：支持 `add/erase` 基础布尔调用。
- [ ] T12 实现 2D 轨迹到 3D 胶囊体生成：在 `brush-engine-3d.ts` 完成反投影和胶囊网格生成。完成标准：参数可控，支持统一曲线细分精度。
- [ ] T13 实现 commit 主链路：`BrushSession.endStroke()` 调用 `BrushEngine3D.commit()` 并返回 `CommitOutput`。完成标准：成功/失败路径都可恢复到一致状态。
- [ ] T14 对接 mesh 更新与跨视图刷新：在 `src/core/batch-gpu-slicer.ts` 和 `src/renderer/multi-view-manager.ts` 接入更新通知。完成标准：提交后其他视图自动重切片，当前视图保持无闪烁连绘策略。
- [ ] T15 补端到端链路测试：新增 `src/core/__tests__/brush-e2e-flow.test.ts`。完成标准：覆盖 `mousedown -> mousemove -> mouseup -> commit` 全流程。

### M4（性能验收与稳定性）
- [ ] T16 增加性能埋点：对 `preview()` 与 `commit()` 记录耗时并输出 p95/p99。完成标准：可导出第 2 节口径下的统计数据。
- [ ] T17 构建验收场景：准备 80k~200k 三角面模型与 1k~6k 段切面样本。完成标准：可重复执行 200 帧预览和 50 次提交采样。
- [ ] T18 完成性能报告：记录机器、浏览器版本、冷/热启动数据。完成标准：预览与提交达到第 2 节目标，或给出明确瓶颈定位。
- [ ] T19 稳定性与资源释放验证：连续 100 次笔画压测，检查 Wasm/GPU 资源释放。完成标准：无崩溃、无持续内存增长、无新增 console error。
- [ ] T20 异常处理收口：统一错误码与回滚策略（commitFail、Wasm init fail、输入退化）。完成标准：失败不污染会话状态，用户可继续下一笔。
