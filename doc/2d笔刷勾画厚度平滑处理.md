# 2D 笔刷勾画厚度平滑处理方案

## 1. 目标与背景
- 目标：在 axial 相邻层分别绘制后，sagittal/coronal 视图中的结果应连续平滑，避免“阶梯状”变化。
- 保留语义：同一绘制视角下，单层编辑仍按层厚处理，不改变“当前层直接编辑语义”。
- 结果要求：平滑效果写入真实 3D 几何，而不是只做显示层插值。

## 2. 已确认约束
- 当前层厚按层距处理，首版层距固定为 `1.0`（等效当前上下各 `0.5`）。
- 单层行为保持“平顶平底”。
- 跨层连接仅在“相邻层”之间进行。
- 连接规则为“重叠优先”：只在相邻两层轮廓重叠区域做连接。
- `add` / `erase` 两种模式都支持平滑连接。

## 3. 总体方案
- 在 `BrushEngine3D` 提交阶段新增“跨层连接体（bridge solid）”构建逻辑。
- 现有本层 cutter 布尔逻辑保留；bridge 作为附加体参与最终布尔。
- 以绘制法向为分组，缓存每个 `layerIndex` 的 2D footprint（笔刷布尔后的闭环轮廓）。
- 当提交当前层时，读取相邻层 footprint，基于重叠区域构建层间连接体并并入/扣除 mesh。

## 4. 接口与类型变更
在 `src/core/brush/brush-engine-3d.ts` 的 `BrushEngine3DOptions` 增加：

- `layerSpacingMm?: number`  
  默认 `1.0`，用于 layer 索引推导与层间距离计算。
- `interSliceBlend?: {`
- `  enabled?: boolean`
- `  samplesPerGap?: number`
- `  overlapOnly?: boolean`
- `}`

建议默认值：
- `interSliceBlend.enabled = true`
- `interSliceBlend.samplesPerGap = 4`
- `interSliceBlend.overlapOnly = true`

## 5. 核心实现步骤

### 5.1 新增跨层状态缓存
- 新建 `src/core/brush/inter-slice-bridge-state.ts`。
- 缓存键建议：`meshId + normalQuantized`。
- 值结构：`Map<layerIndex, LayerFootprint>`，其中 `LayerFootprint` 保存闭环 polygons（2D）。

### 5.2 layerIndex 推导
- 使用 `layerIndex = round(dot(anchor, normal) / layerSpacingMm)`。
- 对 `normal` 做归一化，避免漂移导致层索引抖动。

### 5.3 bridge 生成
- 对当前层与 `layerIndex ± 1` 邻层执行匹配。
- 先求 `overlap = intersect(currPolygons, neighborPolygons)`，若空则不连。
- 在 `z0 ~ z1` 间做 `samplesPerGap` 采样（不含端点层），生成中间截面。
- 将中间截面薄挤出后 `union` 为 `bridgeSolid`。
- 若轮廓拓扑不一致，回退到“overlap 恒截面桥接”策略，保证稳定性优先。

### 5.4 布尔合成
- `add`：`result = source.add(baseCutter).add(bridgeSolid)`
- `erase`：`result = source.subtract(baseCutter).subtract(bridgeSolid)`
- 保持原有 stitched/rebuild 流程，减少共面缝与重复 segment。

### 5.5 Demo 接线
在 `src/demo/main.ts` 的 `createBrushEngine3D` 配置中启用：
- `layerSpacingMm: 1.0`
- `interSliceBlend: { enabled: true, samplesPerGap: 4, overlapOnly: true }`

## 6. 测试计划
新增：`src/core/__tests__/brush-engine-3d-inter-slice.test.ts`

- 用例 1：单层提交不外溢  
  仅编辑 `z=0`，验证 `z=±1` anchor 切面不出现非预期改动。

- 用例 2：双层相邻平滑  
  `z=0` 与 `z=1` 分别画笔，验证 sagittal 切面边界连续，无明显台阶跳变。

- 用例 3：重叠优先规则  
  相邻层无重叠时不生成 bridge；有重叠时生成 bridge。

- 用例 4：erase 对称性  
  `erase` 模式同样生成跨层连续几何，行为与 `add` 对称。

- 用例 5：拓扑回退稳定性  
  轮廓差异大时触发回退路径，提交不报错且可正常切片。

## 7. 验收标准
- axial 相邻层分别绘制后，sagittal/coronal 连续性明显改善，消除阶梯感。
- 当前绘制层语义保持一致，单层编辑行为与现有体验一致。
- `add/erase` 均可用，且 commit 稳定性不低于当前实现。
- 现有 brush 相关回归测试通过，新增跨层测试通过。

## 8. 假设与默认值
- 首版层距固定 `1.0`，后续再接入影像 spacing 元数据。
- 仅连接相邻层（`|ΔlayerIndex|=1`）。
- 首版仅处理同一绘制法向分组内的跨层连接。
- 优先稳健性，必要时使用回退策略避免几何异常。
