import{C as Oe,c as Ve,b as ce,p as je,n as R,a as pe,s as ze,d as xe,e as Ye,M as Ie,f as we}from"./index-77LIymxU.js";function Xe(){const t=new Float32Array([-50,-50,-50,50,-50,-50,50,50,-50,-50,50,-50,-50,-50,50,50,-50,50,50,50,50,-50,50,50]),e=new Uint32Array([0,2,1,0,3,2,4,5,6,4,6,7,0,1,5,0,5,4,2,3,7,2,7,6,0,4,7,0,7,3,1,2,6,1,6,5]),n=new Float32Array([-.577,-.577,-.577,.577,-.577,-.577,.577,.577,-.577,-.577,.577,-.577,-.577,-.577,.577,.577,-.577,.577,.577,.577,.577,-.577,.577,.577]);return{vertices:t,indices:e,normals:n}}class Ge{constructor(e){this.slicer=null,this.initPromise=null,this.camera=null,this.anchor=[0,0,0],this.lastResult=null,this.renderPending=!1,this.canvasRenderer=new Oe(e),this.initPromise=this.initSlicer()}get backend(){var e;return((e=this.slicer)==null?void 0:e.backend)??"pending"}async ready(){await this.initPromise}async setMesh(e){await this.initPromise,await this.slicer.init(e),await this.render()}async updateSlice(e,n){this.camera=e,this.anchor=n,await this.render()}async setRenderStyle(e,n,s){this.canvasRenderer.setStyle({color:e,lineWidth:n,scale:s}),await this.render()}getLastResult(){return this.lastResult}dispose(){var e;(e=this.slicer)==null||e.dispose(),this.slicer=null}async initSlicer(){this.slicer=await Ve()}async render(){if(!this.slicer||!this.camera){this.canvasRenderer.clear(),this.lastResult=null;return}if(!this.renderPending){this.renderPending=!0;try{const e=await this.slicer.slice(this.camera.viewPlaneNormal,this.anchor),n=ce(this.camera.viewPlaneNormal,this.camera.viewUp),s=je(e,this.anchor,n,this.canvasRenderer.width,this.canvasRenderer.height,this.canvasRenderer.scale);this.lastResult={segments3D:e,segments2D:s},this.canvasRenderer.drawSegments(s)}finally{this.renderPending=!1}}}}function He(t){return{a:{x:t.a.x,y:t.a.y},b:{x:t.b.x,y:t.b.y}}}class Qe{constructor(e,n={}){this.segments=[],this.disposed=!1;const s=e.getContext("2d");if(!s)throw new Error("Failed to get 2D context for line renderer");this.canvas=e,this.ctx=s,this.color=n.color??"#f5f5f5",this.lineWidthPx=n.lineWidthPx??2,this.scale=n.scale??1,this.alpha=n.alpha??1,this.clearBeforeRender=n.clearBeforeRender??!1}setSegments(e){this.segments=e.map(He)}setScale(e){this.scale=e}setStyle(e){e.color!==void 0&&(this.color=e.color),e.lineWidthPx!==void 0&&(this.lineWidthPx=e.lineWidthPx),e.alpha!==void 0&&(this.alpha=e.alpha),e.clearBeforeRender!==void 0&&(this.clearBeforeRender=e.clearBeforeRender)}render(){if(this.disposed)return;const e=this.canvas.width,n=this.canvas.height,s=e*.5,i=n*.5;if(this.clearBeforeRender&&this.ctx.clearRect(0,0,e,n),this.segments.length!==0){this.ctx.save(),this.ctx.strokeStyle=this.color,this.ctx.globalAlpha=this.alpha,this.ctx.lineWidth=this.lineWidthPx,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath();for(const r of this.segments){const a=s+r.a.x*this.scale,c=i-r.a.y*this.scale,l=s+r.b.x*this.scale,h=i-r.b.y*this.scale;this.ctx.moveTo(a,c),this.ctx.lineTo(l,h)}this.ctx.stroke(),this.ctx.restore()}}dispose(){this.segments=[],this.disposed=!0}}class Je{constructor(e,n){this.activeSegments=[],this.backgroundBitmap=null,this.activeBitmap=null;const s=e.getContext("2d");if(!s)throw new Error("Failed to get 2D context for BrushOverlayRenderer");this.canvas=e,this.ctx=s,this.scale=n.scale,this.brushColor=n.brushColor??n.activeColor??"#f5f5f5",this.showBrushTrail=n.showBrushTrail??!0,this.autoCloseBitmaps=n.autoCloseBitmaps??!1,this.lineRenderer=new Qe(e,{color:n.activeColor??"#f5f5f5",lineWidthPx:n.activeLineWidthPx??2,scale:this.scale,clearBeforeRender:!1})}setScale(e){this.scale=e,this.lineRenderer.setScale(e)}setBrushColor(e){this.brushColor=e}setBackgroundBitmap(e){this.autoCloseBitmaps&&this.backgroundBitmap&&this.backgroundBitmap!==e&&this.backgroundBitmap.close(),this.backgroundBitmap=e}setActiveBitmap(e){this.autoCloseBitmaps&&this.activeBitmap&&this.activeBitmap!==e&&this.activeBitmap.close(),this.activeBitmap=e}setActiveSegments(e){this.activeSegments=e.map(n=>({a:{x:n.a.x,y:n.a.y},b:{x:n.b.x,y:n.b.y}}))}renderStatic(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.backgroundBitmap&&this.ctx.drawImage(this.backgroundBitmap,0,0,this.canvas.width,this.canvas.height),this.activeBitmap&&this.ctx.drawImage(this.activeBitmap,0,0,this.canvas.width,this.canvas.height),this.lineRenderer.setSegments(this.activeSegments),this.lineRenderer.render()}renderPreview(e,n,s){this.setActiveSegments(e),this.renderStatic(),this.showBrushTrail&&this.drawBrushPolygon(n,s)}renderCursor(e,n,s){const[i,r]=this.mmToCanvas(e),a=Math.max(1,n*this.scale);this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i,r,a,0,Math.PI*2),this.ctx.lineWidth=1.5,this.ctx.strokeStyle=this.brushColor,this.ctx.globalAlpha=.95,this.ctx.stroke(),this.ctx.restore()}renderCommittedActive(e){this.setActiveSegments(e),this.renderStatic()}clear(){this.activeSegments=[],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}dispose(){var e,n;this.lineRenderer.dispose(),this.autoCloseBitmaps&&((e=this.backgroundBitmap)==null||e.close(),(n=this.activeBitmap)==null||n.close()),this.backgroundBitmap=null,this.activeBitmap=null,this.activeSegments=[]}drawBrushPolygon(e,n){if(e.length<3)return;this.ctx.save(),this.ctx.beginPath();const[s,i]=this.mmToCanvas(e[0]);this.ctx.moveTo(s,i);for(let r=1;r<e.length;r++){const[a,c]=this.mmToCanvas(e[r]);this.ctx.lineTo(a,c)}this.ctx.closePath(),this.ctx.strokeStyle=this.withAlpha(this.brushColor,.9),this.ctx.lineWidth=1.25,this.ctx.stroke(),this.ctx.restore()}mmToCanvas(e){return[this.canvas.width*.5+e.x*this.scale,this.canvas.height*.5-e.y*this.scale]}withAlpha(e,n){if(e.startsWith("#")&&e.length===7){const s=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);return`rgba(${s}, ${i}, ${r}, ${n})`}return e}}class Ze{constructor(){this.views=new Map}registerView(e){this.views.set(e.id,e)}unregisterView(e){this.views.delete(e)}async refreshOtherViews(e,n="meshUpdated"){const s=[];for(const[i,r]of this.views)i!==e&&s.push(Promise.resolve(r.refresh(n)));await Promise.all(s)}async refreshAllViews(e="full"){const n=[];for(const s of this.views.values())n.push(Promise.resolve(s.refresh(e)));await Promise.all(n)}}const Re=1e3,Te=.1,De=.05,et=1e-9;function S(t){return{x:t.x,y:t.y}}function le(t,e){const n=e.x-t.x,s=e.y-t.y;return n*n+s*s}function tt(t,e,n){const s=n.x-e.x,i=n.y-e.y,r=s*s+i*i;if(r<=et)return Math.sqrt(le(t,e));const a=((t.x-e.x)*s+(t.y-e.y)*i)/r,c=Math.max(0,Math.min(1,a)),l=e.x+s*c,h=e.y+i*c,u=t.x-l,o=t.y-h;return Math.sqrt(u*u+o*o)}function ee(t,e){if(t.length<=2)return t.map(S);let n=-1,s=-1;for(let a=1;a<t.length-1;a++){const c=tt(t[a],t[0],t[t.length-1]);c>n&&(n=c,s=a)}if(n<=e||s===-1)return[S(t[0]),S(t[t.length-1])];const i=ee(t.slice(0,s+1),e),r=ee(t.slice(s),e);return[...i.slice(0,i.length-1),...r]}function nt(t,e){if(t.length===0)return[];const n=e*e,s=[S(t[0])];for(let i=1;i<t.length;i++)le(s[s.length-1],t[i])>=n&&s.push(S(t[i]));return s.length===1&&t.length>1&&s.push(S(t[t.length-1])),s}function Le(t,e={}){if(t.length===0)return[];if(t.length===1)return[S(t[0])];const n=e.epsilonMm??Te,s=e.minDistanceMm??De,i=nt(t,s);return i.length<=2?i:ee(i,n)}function st(t,e,n,s={}){return{points:t.map(S),simplified:Le(t,s),radiusMm:e,mode:n}}class it{constructor(e={}){this.points=[],this.radiusMm=0,this.mode="add",this.options=e}begin(e,n,s){this.points=[S(e)],this.radiusMm=n,this.mode=s}append(e){if(this.points.length===0)return!1;const n=this.options.minDistanceMm??De,s=n*n;return le(this.points[this.points.length-1],e)<s?!1:(this.points.push(S(e)),!0)}snapshot(){return st(this.points,this.radiusMm,this.mode,this.options)}clear(){this.points=[],this.radiusMm=0,this.mode="add"}get rawPoints(){return this.points.map(S)}}const rt="modulepreload",at=function(t){return"/"+t},ve={},ot=function(e,n,s){let i=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),c=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));i=Promise.allSettled(n.map(l=>{if(l=at(l),l in ve)return;ve[l]=!0;const h=l.endsWith(".css"),u=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const o=document.createElement("link");if(o.rel=h?"stylesheet":rt,h||(o.as="script"),o.crossOrigin="",o.href=l,c&&o.setAttribute("nonce",c),document.head.appendChild(o),h)return new Promise((m,d)=>{o.addEventListener("load",m),o.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${l}`)))})}))}function r(a){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=a,window.dispatchEvent(c),!c.defaultPrevented)throw a}return i.then(a=>{for(const c of a||[])c.status==="rejected"&&r(c.reason);return e().catch(r)})},ct="/assets/clipper2z-bvMLVKp3.wasm",lt=3,ht=2,ut=0,D=1e3,dt=24;let z=null;function g(t){!t||typeof t.delete!="function"||t.delete()}function mt(t){return t.length>=4&&t[0]===0&&t[1]===97&&t[2]===115&&t[3]===109}function $(t){return{a:{x:t.a.x,y:t.a.y},b:{x:t.b.x,y:t.b.y}}}function _(t){return{x:t.x,y:t.y}}function ft(t,e,n=dt){const s=[],i=Math.max(8,n);for(let r=0;r<i;r++){const a=Math.PI*2*r/i;s.push({x:t.x+Math.cos(a)*e,y:t.y+Math.sin(a)*e})}return s}function N(t){return`${Math.round(t.x*D)},${Math.round(t.y*D)}`}function Se(t){return{x:Math.round(t.x*D)/D,y:Math.round(t.y*D)/D}}function yt(t){const e=[];for(const a of t){const c=Se(a.a),l=Se(a.b);e.push({a:c,b:l,aKey:N(c),bKey:N(l)})}const n=new Map;for(let a=0;a<e.length;a++){const c=e[a];n.has(c.aKey)||n.set(c.aKey,[]),n.has(c.bKey)||n.set(c.bKey,[]),n.get(c.aKey).push(a),n.get(c.bKey).push(a)}const s=new Array(e.length).fill(!1),i=[],r=[];for(let a=0;a<e.length;a++){if(s[a])continue;const c=e[a];s[a]=!0;const l=c.aKey;let h=c.aKey,u=c.bKey;const o=[_(c.a),_(c.b)];for(;u!==l;){const d=(n.get(u)??[]).filter(w=>!s[w]);if(d.length===0)break;let f=d[0];if(d.length>1){const w=d.find(K=>{const j=e[K];return(j.aKey===u?j.bKey:j.aKey)!==h});w!==void 0&&(f=w)}const y=e[f];s[f]=!0;const E=y.aKey===u?y.bKey:y.aKey,C=y.aKey===u?y.b:y.a;o.push(_(C)),h=u,u=E}if(u===l&&o.length>=4){const d=N(o[0]),f=N(o[o.length-1]);if(d===f&&o.pop(),o.length>=3){i.push(o);continue}}for(let d=0;d<o.length-1;d++)r.push({a:_(o[d]),b:_(o[d+1])})}return{closedLoops:i,openSegments:r}}function gt(t){if(t.length<3)return 0;let e=0;for(let n=0;n<t.length;n++){const s=(n+1)%t.length;e+=t[n].x*t[s].y-t[s].x*t[n].y}return e*.5}function pt(t){let e=[],n=0;for(const s of t){const i=Math.abs(gt(s));i>n&&(e=s,n=i)}return e}function Y(t){if(t.length<2)return[];const e=[];for(let n=0;n<t.length;n++){const s=(n+1)%t.length;e.push({a:{x:t[n].x,y:t[n].y},b:{x:t[s].x,y:t[s].y}})}return e}class xt{constructor(e,n){this.module=e,this.precisionDigits=n.precisionDigits??lt,this.miterLimit=n.miterLimit??ht,this.arcTolerance=n.arcTolerance??ut}inflateStrokeToPolygon(e,n){if(e.length===0||n<=0)return[];if(e.length===1)return ft(e[0],n);const s=this.createPaths([e]);try{const i=this.module.InflatePathsD(s,n,this.module.JoinType.Round,this.module.EndType.Round,this.miterLimit,this.arcTolerance,this.precisionDigits);try{const r=this.readPaths(i);return pt(r)}finally{g(i)}}finally{g(s)}}applyBoolean(e,n,s){return n.length<3?e.map($):s==="add"?this.addWithUnion(e,n):this.eraseWithDifference(e,n)}createClipperInstance(){try{return new this.module.ClipperD}catch(e){if(typeof this.module.CreateClipperD=="function")try{return this.module.CreateClipperD(!0)}catch(n){throw new Error(`Failed to create ClipperD instance via ctor/factory. ctor=${e instanceof Error?e.message:String(e)}, factory=${n instanceof Error?n.message:String(n)}`)}throw e}}addWithUnion(e,n){const s=yt(e);if(s.closedLoops.length===0){const u=e.map($);return u.push(...Y(n)),u}const i=this.createPaths(s.closedLoops),r=this.createPaths(s.openSegments.map(u=>[u.a,u.b])),a=this.createPaths([n]),c=this.createClipperInstance(),l=new this.module.PathsD,h=new this.module.PathsD;try{if(c.SetPreserveCollinear(!0),c.AddSubject(i),s.openSegments.length>0&&c.AddOpenSubject(r),c.AddClip(a),!c.ExecutePath(this.module.ClipType.Union,this.module.FillRule.NonZero,l,h)){const d=e.map($);return d.push(...Y(n)),d}const o=s.openSegments.map($),m=this.readPaths(l);for(const d of m)o.push(...Y(d));return o}finally{g(h),g(l),g(c),g(a),g(r),g(i)}}eraseWithDifference(e,n){if(e.length===0)return[];const s=this.createPaths(e.map(l=>[l.a,l.b])),i=this.createPaths([n]),r=this.createClipperInstance(),a=new this.module.PathsD,c=new this.module.PathsD;try{return r.SetPreserveCollinear(!0),r.AddOpenSubject(s),r.AddClip(i),r.ExecutePath(this.module.ClipType.Difference,this.module.FillRule.NonZero,a,c)?this.readPathsAsOpenSegments(c):e.map($)}finally{g(c),g(a),g(r),g(i),g(s)}}createPath(e){const n=new this.module.PathD;for(const s of e){const i=new this.module.PointD(s.x,s.y,0);n.push_back(i),g(i)}return n}createPaths(e){const n=new this.module.PathsD;for(const s of e){if(s.length===0)continue;const i=this.createPath(s);n.push_back(i),g(i)}return n}readPath(e){const n=[],s=e.size();for(let i=0;i<s;i++){const r=e.get(i);n.push({x:r.x,y:r.y}),g(r)}return n}readPaths(e){const n=[],s=e.size();for(let i=0;i<s;i++){const r=e.get(i),a=this.readPath(r);g(r),a.length>0&&n.push(a)}return n}readPathsAsOpenSegments(e){const n=[],s=this.readPaths(e);for(const i of s)for(let r=0;r<i.length-1;r++)n.push({a:{x:i[r].x,y:i[r].y},b:{x:i[r+1].x,y:i[r+1].y}});return n}}async function wt(){const t=await ot(()=>import("./clipper2z-BhbiJ9EC.js"),[]),e=t.default??t,n=String(ct),i=await(await fetch(n,{credentials:"same-origin"})).arrayBuffer(),r=new Uint8Array(i);if(!mt(r)){const a=Array.from(r.slice(0,4)).map(c=>c.toString(16).padStart(2,"0")).join(" ");throw new Error(`Invalid wasm binary from ${n}, header=${a}`)}return e({wasmBinary:r,locateFile:a=>a.includes(".wasm")?n:a})}async function vt(){return z||(z=wt()),z}async function St(t={}){const e=await vt();return new xt(e,t)}const B=1e-9;function X(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}function L(t){return{x:t.x,y:t.y}}function he(t){return{a:L(t.a),b:L(t.b)}}function O(t,e,n,s){return t*n+e*s}function F(t,e,n,s){return t*s-e*n}function $e(t,e){const n=e.x-t.x,s=e.y-t.y;return n*n+s*s}function G(t,e){const n=Math.hypot(t,e);return n<=B?{x:1,y:0}:{x:t/n,y:e/n}}function be(t,e){for(let n=1;n<e.length;n++)t.push(e[n])}function bt(t,e){const n=t.a,s=e.a,i=t.b.x-t.a.x,r=t.b.y-t.a.y,a=e.b.x-e.a.x,c=e.b.y-e.a.y,l=F(i,r,a,c);if(Math.abs(l)<=B)return null;const h=s.x-n.x,u=s.y-n.y,o=F(h,u,a,c)/l,m=F(h,u,i,r)/l;return o<-B||o>1+B||m<-B||m>1+B?null:Math.max(0,Math.min(1,o))}function Pt(t,e,n){const s=e.b.x-e.a.x,i=e.b.y-e.a.y,r=t.x-e.a.x,a=t.y-e.a.y;if(Math.abs(F(s,i,r,a))>n)return!1;const l=O(r,a,s,i);if(l<-n)return!1;const h=O(s,i,s,i);return!(l>h+n)}function Mt(t,e,n){if(e.length<3)return!1;for(let i=0;i<e.length;i++){const r=(i+1)%e.length;if(Pt(t,{a:e[i],b:e[r]},n))return!0}let s=!1;for(let i=0,r=e.length-1;i<e.length;r=i++){const a=e[i].x,c=e[i].y,l=e[r].x,h=e[r].y;c>t.y!=h>t.y&&t.x<(l-a)*(t.y-c)/(h-c||B)+a&&(s=!s)}return s}function H(t,e){return{x:t.a.x+(t.b.x-t.a.x)*e,y:t.a.y+(t.b.y-t.a.y)*e}}function Ct(t,e,n){if(t.length===0||e<=0)return[];const s=Math.max(6,n);if(t.length===1){const o=[];for(let m=0;m<s;m++){const d=Math.PI*2*m/s;o.push({x:t[0].x+Math.cos(d)*e,y:t[0].y+Math.sin(d)*e})}return o}const i=[];for(let o=0;o<t.length-1;o++){const m=t[o+1].x-t[o].x,d=t[o+1].y-t[o].y,f=G(m,d);i.push({x:-f.y,y:f.x})}const r=[],a=[];for(let o=0;o<t.length;o++){if(o===0){r.push({x:t[o].x+i[0].x*e,y:t[o].y+i[0].y*e}),a.push({x:t[o].x-i[0].x*e,y:t[o].y-i[0].y*e});continue}if(o===t.length-1){const w=i[i.length-1];r.push({x:t[o].x+w.x*e,y:t[o].y+w.y*e}),a.push({x:t[o].x-w.x*e,y:t[o].y-w.y*e});continue}const m=i[o-1],d=i[o],f=G(m.x+d.x,m.y+d.y),y=G(-m.x-d.x,-m.y-d.y),E=Math.max(Math.abs(O(f.x,f.y,d.x,d.y)),.35),C=Math.max(Math.abs(O(y.x,y.y,-d.x,-d.y)),.35);r.push({x:t[o].x+f.x*(e/E),y:t[o].y+f.y*(e/E)}),a.push({x:t[o].x+y.x*(e/C),y:t[o].y+y.y*(e/C)})}const c=(o,m,d)=>{let f=Math.atan2(m.y-o.y,m.x-o.x),y=Math.atan2(d.y-o.y,d.x-o.x);for(;y>=f;)y-=Math.PI*2;const E=[];for(let C=0;C<=s;C++){const w=C/s,K=f+(y-f)*w;E.push({x:o.x+Math.cos(K)*e,y:o.y+Math.sin(K)*e})}return E},l=r.map(L),h=c(t[t.length-1],r[r.length-1],a[a.length-1]);be(l,h);for(let o=a.length-1;o>=0;o--)l.push(L(a[o]));const u=c(t[0],a[0],r[0]);return be(l,u),l.length>1&&$e(l[0],l[l.length-1])<1e-12&&l.pop(),l}function _e(t){if(t.length<2)return[];const e=[];for(let n=0;n<t.length;n++){const s=(n+1)%t.length;e.push({a:L(t[n]),b:L(t[s])})}return e}function Bt(t,e,n){if(e.length<3)return t.map(he);const s=_e(e),i=[];for(const r of t){const a=[0,1];for(const l of s){const h=bt(r,l);h!==null&&a.push(h)}a.sort((l,h)=>l-h);const c=[];for(const l of a)(c.length===0||Math.abs(l-c[c.length-1])>n*.1)&&c.push(l);for(let l=0;l<c.length-1;l++){const h=c[l],u=c[l+1];if(u-h<=B)continue;const o=H(r,(h+u)*.5);Mt(o,e,n*.25)||i.push({a:H(r,h),b:H(r,u)})}}return i}function Et(t,e){const n=t.map(he);return n.push(..._e(e)),n}function Pe(t,e,n){const s=e*e,i=1/Math.max(n,1e-6),r=[],a=new Set,c=l=>Math.round(l*i);for(const l of t){if($e(l.a,l.b)<=s)continue;const h=c(l.a.x),u=c(l.a.y),o=c(l.b.x),m=c(l.b.y),d=`${h},${u}|${o},${m}`,f=`${o},${m}|${h},${u}`,y=d<f?d:f;a.has(y)||(a.add(y),r.push(he(l)))}return r}function At(t){if(t.length===0)return{minX:0,minY:0,maxX:0,maxY:0};let e=t[0].x,n=t[0].y,s=t[0].x,i=t[0].y;for(let r=1;r<t.length;r++)e=Math.min(e,t[r].x),n=Math.min(n,t[r].y),s=Math.max(s,t[r].x),i=Math.max(i,t[r].y);return{minX:e,minY:n,maxX:s,maxY:i}}function kt(t,e=Re){return t.map(n=>({x:Math.round(n.x*e),y:Math.round(n.y*e)}))}function It(t,e=Re){return t.map(n=>({x:n.x/e,y:n.y/e}))}class We{constructor(e={}){this.options={epsilonMm:e.epsilonMm??Te,minDistanceMm:e.minDistanceMm??.05,zeroLengthEpsilonMm:e.zeroLengthEpsilonMm??1e-4,pointMergeEpsilonMm:e.pointMergeEpsilonMm??.001,arcSteps:e.arcSteps??12,clipperAdapter:e.clipperAdapter??null}}preview(e){const n=X(),s=Le(e.strokePoints,{epsilonMm:this.options.epsilonMm,minDistanceMm:this.options.minDistanceMm});if(s.length===0||e.radiusMm<=0){const u=Pe(e.baseSegments,this.options.zeroLengthEpsilonMm,this.options.pointMergeEpsilonMm);return{nextSegments:u,dirtyBoundsMm:{minX:0,minY:0,maxX:0,maxY:0},stats:{segmentCount:u.length,elapsedMs:X()-n},strokeSimplified:s}}const i=kt(s),r=It(i);let a=[],c=[],l=!1;if(this.options.clipperAdapter)try{a=this.options.clipperAdapter.inflateStrokeToPolygon(r,e.radiusMm),a.length>=3&&(c=this.options.clipperAdapter.applyBoolean(e.baseSegments,a,e.mode),l=!0)}catch{l=!1}l||(a=Ct(r,e.radiusMm,this.options.arcSteps),c=e.mode==="erase"?Bt(e.baseSegments,a,this.options.epsilonMm):Et(e.baseSegments,a));const h=Pe(c,this.options.zeroLengthEpsilonMm,this.options.pointMergeEpsilonMm);return{nextSegments:h,dirtyBoundsMm:At(a),stats:{segmentCount:h.length,elapsedMs:X()-n},brushPolygon2D:a,strokeSimplified:r}}}async function Rt(t={}){const e=t.clipperAdapter??await St();return new We({...t,clipperAdapter:e})}function Q(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}function Tt(t,e,n){const s=n.x-e.x,i=n.y-e.y,r=s*s+i*i;if(r<=1e-12){const o=t.x-e.x,m=t.y-e.y;return Math.hypot(o,m)}const a=t.x-e.x,c=t.y-e.y,l=Math.max(0,Math.min(1,(a*s+c*i)/r)),h=e.x+s*l,u=e.y+i*l;return Math.hypot(t.x-h,t.y-u)}function Dt(t,e){if(e.length===0)return 1/0;if(e.length===1)return Math.hypot(t.x-e[0].x,t.y-e[0].y);let n=1/0;for(let s=0;s<e.length-1;s++)n=Math.min(n,Tt(t,e[s],e[s+1]));return n}function Lt(t){const e=Math.max(0,Math.min(1,t));return e*e*(3-2*e)}function $t(t){const e=R(t.slicePlane.normal),n=t.slicePlane.anchor;if(t.slicePlane.xAxis&&t.slicePlane.yAxis){const a=R(t.slicePlane.xAxis),c=R(t.slicePlane.yAxis);return{normal:e,anchor:n,xAxis:a,yAxis:c}}const s=Math.abs(e[2])<.9?[0,0,1]:[0,1,0],i=R(pe(s,e)),r=R(pe(e,i));return{normal:e,anchor:n,xAxis:i,yAxis:r}}function _t(t,e){const n=ze(t,e.anchor);return{x:xe(n,e.xAxis),y:xe(n,e.yAxis)}}function Me(t){return{vertices:new Float32Array(t.vertices),indices:new Uint32Array(t.indices),normals:t.normals?new Float32Array(t.normals):void 0}}class Wt{constructor(e={}){this.commitSeq=0,this.options={displacementScaleMm:e.displacementScaleMm??.3,falloffMm:e.falloffMm??.5,idPrefix:e.idPrefix??"brush"}}async commit(e){const n=Q(),s=$t(e),i=e.stroke.simplified.length>0?e.stroke.simplified:e.stroke.points;if(i.length===0||e.stroke.radiusMm<=0)return{newMeshId:`${e.meshId}:${this.options.idPrefix}:${++this.commitSeq}`,mesh:Me(e.mesh),triangleCount:e.mesh.indices.length/3,elapsedMs:Q()-n};const r=Me(e.mesh),a=r.vertices,c=e.stroke.radiusMm+this.options.falloffMm,l=e.stroke.mode==="add"?1:-1;for(let h=0;h<a.length;h+=3){const u=[a[h],a[h+1],a[h+2]],o=_t(u,s),m=Dt(o,i);if(m>c)continue;const d=m/Math.max(c,1e-6),f=1-Lt(d);if(f<=0)continue;const y=l*this.options.displacementScaleMm*f;a[h]+=s.normal[0]*y,a[h+1]+=s.normal[1]*y,a[h+2]+=s.normal[2]*y}return r.normals=void 0,{newMeshId:`${e.meshId}:${this.options.idPrefix}:${++this.commitSeq}`,mesh:r,triangleCount:r.indices.length/3,elapsedMs:Q()-n}}}function Ut(t){return{a:{x:t.a.x,y:t.a.y},b:{x:t.b.x,y:t.b.y}}}function M(t){return t.map(Ut)}function q(t){return{nextSegments:M(t),dirtyBoundsMm:{minX:0,minY:0,maxX:0,maxY:0},stats:{segmentCount:t.length,elapsedMs:0}}}class Kt{constructor(e,n){this.strokeBuilder=new it,this.state="idle",this.preStrokeSnapshot=[],this.lastPreview=null,this.previewToken=0,this.commitPromise=null,this.pendingInvalidateReason=null,this.invalidatedReason="meshChanged",this.baseSegments=M(e),this.deps=n}get currentState(){return this.state}getCurrentSegments(){return this.lastPreview?M(this.lastPreview.nextSegments):M(this.baseSegments)}setBaseSegments(e){var n,s;this.baseSegments=M(e),(this.state==="idle"||this.state==="invalidated")&&(this.lastPreview=q(this.baseSegments),(s=(n=this.deps).onPreview)==null||s.call(n,this.lastPreview))}beginStroke(e,n,s){if(this.state!=="idle")throw new Error(`Cannot begin stroke while state=${this.state}`);this.preStrokeSnapshot=M(this.baseSegments),this.lastPreview=null,this.previewToken=0,this.strokeBuilder.begin(e,n,s),this.transitionTo("drawing")}appendPoint(e){var a,c,l;if(this.state!=="drawing")return null;this.strokeBuilder.append(e);const n=++this.previewToken,s=this.strokeBuilder.snapshot(),i=((a=this.lastPreview)==null?void 0:a.nextSegments)??this.preStrokeSnapshot,r=this.deps.previewEngine.preview({baseSegments:i,strokePoints:s.points,radiusMm:s.radiusMm,mode:s.mode});return n!==this.previewToken?null:(this.lastPreview=r,(l=(c=this.deps).onPreview)==null||l.call(c,r),r)}async endStroke(){var s,i,r,a,c,l,h,u;if(this.state!=="drawing")throw new Error(`Cannot commit stroke while state=${this.state}`);if(this.commitPromise)throw new Error("Commit is already running (single-flight)");const e=this.strokeBuilder.snapshot();this.lastPreview||(this.lastPreview=this.deps.previewEngine.preview({baseSegments:this.preStrokeSnapshot,strokePoints:e.points,radiusMm:e.radiusMm,mode:e.mode}),(i=(s=this.deps).onPreview)==null||i.call(s,this.lastPreview)),this.transitionTo("committing");const n={...this.deps.createCommitInput(e),stroke:e};this.commitPromise=this.deps.commitEngine.commit(n);try{const o=await this.commitPromise;return this.baseSegments=M(this.lastPreview.nextSegments),(a=(r=this.deps).onCommitSuccess)==null||a.call(r,o),this.finishStrokeToIdle(),o}catch(o){this.baseSegments=M(this.preStrokeSnapshot);const m=q(this.baseSegments);throw this.lastPreview=m,(l=(c=this.deps).onPreview)==null||l.call(c,m),(u=(h=this.deps).onCommitFail)==null||u.call(h,o),this.finishStrokeToIdle(),o}finally{this.commitPromise=null}}cancelStroke(){var e,n;this.state==="drawing"&&(this.baseSegments=M(this.preStrokeSnapshot),this.lastPreview=q(this.baseSegments),(n=(e=this.deps).onPreview)==null||n.call(e,this.lastPreview),this.finishStrokeToIdle())}invalidate(e){if(this.state==="drawing"||this.state==="committing"){this.pendingInvalidateReason=e;return}this.invalidatedReason=e,this.transitionTo("invalidated")}async resliceIfNeeded(){var s,i;if(this.state!=="invalidated")return;const e=this.invalidatedReason;if(!this.deps.requestReslice){this.transitionTo("idle");return}const n=await this.deps.requestReslice(e);this.baseSegments=M(n),this.lastPreview=q(this.baseSegments),(i=(s=this.deps).onPreview)==null||i.call(s,this.lastPreview),this.transitionTo("idle")}finishStrokeToIdle(){if(this.strokeBuilder.clear(),this.preStrokeSnapshot=[],this.previewToken=0,this.pendingInvalidateReason){this.invalidatedReason=this.pendingInvalidateReason,this.pendingInvalidateReason=null,this.transitionTo("invalidated");return}this.transitionTo("idle")}transitionTo(e){var s,i;if(e===this.state)return;const n=this.state;this.state=e,(i=(s=this.deps).onStateChange)==null||i.call(s,e,n)}}function Nt(t,e){return new Kt(t,e)}const V=3,Ue=[.91,.27,.38,1],Ke=6;function qt(t){const e=Math.round(Math.max(0,Math.min(1,t[0]))*255),n=Math.round(Math.max(0,Math.min(1,t[1]))*255),s=Math.round(Math.max(0,Math.min(1,t[2]))*255);return`rgb(${e}, ${n}, ${s})`}const te=qt(Ue),T=document.getElementById("canvas"),ne=document.getElementById("slider"),Ft=document.getElementById("slider-value"),Ce=document.getElementById("backend-label"),se=document.getElementById("btn-axial"),ie=document.getElementById("btn-sagittal"),re=document.getElementById("btn-coronal"),ae=document.getElementById("btn-custom"),Ot=document.getElementById("custom-panel"),ue=document.getElementById("nx"),de=document.getElementById("ny"),me=document.getElementById("nz"),fe=document.getElementById("ux"),ye=document.getElementById("uy"),ge=document.getElementById("uz"),Vt=document.getElementById("brush-panel"),Ne=document.getElementById("btn-brush-add"),qe=document.getElementById("btn-brush-erase"),oe=document.getElementById("brush-radius"),Fe=document.getElementById("brush-radius-value");let U="Axial",Be=0,I=!1,A=!1,b=null,W=Xe(),Ee="mesh-0",P=Ie[U],k=[0,0,0],x="add",v=Number(oe.value)||Ke;Fe.textContent=`${v} mm`;const p=new Je(T,{scale:V,activeColor:te,brushColor:te,showBrushTrail:!1,activeLineWidthPx:2}),jt=new Wt({displacementScaleMm:.35,falloffMm:.35,idPrefix:"demo-brush"});async function zt(){try{return await Rt()}catch(t){return console.warn("Clipper2-WASM init failed, fallback to TS preview engine:",t),new We}}function Yt(){const t=R([Number(ue.value)||0,Number(de.value)||0,Number(me.value)||0]),e=R([Number(fe.value)||0,Number(ye.value)||0,Number(ge.value)||1]);return{viewPlaneNormal:t,viewUp:e}}function Xt(){return U==="Custom"?Yt():Ie[U]}function Gt(t,e){const n=t.viewPlaneNormal;return[-n[0]*e,-n[1]*e,-n[2]*e]}function Ae(t,e,n){const s=ce(e.viewPlaneNormal,e.viewUp);return t.map(i=>{const r=we(i.start,n,s),a=we(i.end,n,s);return{a:{x:r[0],y:r[1]},b:{x:a[0],y:a[1]}}})}function J(){Ne.classList.toggle("active",x==="add"),qe.classList.toggle("active",x==="erase")}function Z(t){I=t,ne.disabled=t,se.disabled=t,ie.disabled=t,re.disabled=t,ae.disabled=t,ue.disabled=t,de.disabled=t,me.disabled=t,fe.disabled=t,ye.disabled=t,ge.disabled=t}function ke(t){const e=T.getBoundingClientRect(),n=t.clientX-e.left,s=t.clientY-e.top;return{x:(n-T.width*.5)/V,y:(T.height*.5-s)/V}}async function Ht(){const t=await Ye();let e=null;const n=new Ze;let s=null;if(t){Ce.textContent="åŽç«¯: ðŸŸ¢ GPU Bitmap (WebGPU) + Brush Session",await t.initBatch([W],[Ue]);const h=await zt();s=Nt([],{previewEngine:h,commitEngine:jt,createCommitInput:()=>{const u=ce(P.viewPlaneNormal,P.viewUp);return{meshId:Ee,mesh:W,slicePlane:{normal:[...P.viewPlaneNormal],anchor:[...k],xAxis:u.xAxis,yAxis:u.yAxis}}},requestReslice:async()=>{const u=await t.sliceBatchFlat(P.viewPlaneNormal,k);return Ae(u,P,k)},onCommitFail:u=>{console.error("Brush commit failed:",u)}}),n.registerView({id:"main",refresh:async()=>{await i()}})}else{Vt.style.display="none",e=new Ge(T),await e.ready();const h=e.backend==="gpu"?"ðŸŸ¢ GPU (WebGPU)":"ðŸ”µ CPU (Fallback)";Ce.textContent=`åŽç«¯: ${h}`,await e.setMesh(W),await e.setRenderStyle(te,2,V)}async function i(){if(I)return;const h=++Be,u=Number(ne.value);if(Ft.textContent=`${u} mm`,P=Xt(),k=Gt(P,u),t&&s){try{const o=await t.sliceBatchFlat(P.viewPlaneNormal,k);if(h!==Be)return;const m=Ae(o,P,k);s.setBaseSegments(m),p.renderCommittedActive(m),!A&&b&&p.renderCursor(b,v,x)}catch(o){console.error("Brush path update failed:",o)}return}e&&await e.updateSlice(P,k)}const r=[se,ie,re,ae],a=["Axial","Sagittal","Coronal","Custom"];function c(h){I||(U=h,r.forEach((u,o)=>{u.classList.toggle("active",a[o]===h)}),Ot.style.display=h==="Custom"?"flex":"none",s&&s.invalidate("cameraRotate"),i())}async function l(){if(!(!s||s.currentState!=="drawing"))try{const h=await s.endStroke();W=h.mesh,Ee=h.newMeshId,t&&await t.updateMesh(0,W),await n.refreshOtherViews("main","meshUpdated"),await i()}catch(h){console.error("Commit stroke failed:",h),p.renderCommittedActive(s.getCurrentSegments())}finally{Z(!1)}}se.addEventListener("click",()=>c("Axial")),ie.addEventListener("click",()=>c("Sagittal")),re.addEventListener("click",()=>c("Coronal")),ae.addEventListener("click",()=>c("Custom")),ne.addEventListener("input",()=>{I||(s&&s.invalidate("anchorScroll"),i())});for(const h of[ue,de,me,fe,ye,ge])h.addEventListener("input",()=>{I||U==="Custom"&&(s&&s.invalidate("cameraRotate"),i())});Ne.addEventListener("click",()=>{I||(x="add",J(),b&&s&&(p.renderCommittedActive(s.getCurrentSegments()),p.renderCursor(b,v,x)))}),qe.addEventListener("click",()=>{I||(x="erase",J(),b&&s&&(p.renderCommittedActive(s.getCurrentSegments()),p.renderCursor(b,v,x)))}),oe.addEventListener("input",()=>{v=Math.max(.1,Number(oe.value)||Ke),Fe.textContent=`${v} mm`,b&&s&&(p.renderCommittedActive(s.getCurrentSegments()),p.renderCursor(b,v,x))}),T.addEventListener("mousedown",h=>{if(!s||s.currentState!=="idle")return;A=!0;const u=ke(h);b=u;try{s.beginStroke(u,v,x);const o=s.appendPoint(u);o&&p.renderPreview(o.nextSegments,o.brushPolygon2D??[],x),p.renderCursor(u,v,x),Z(!0)}catch(o){A=!1,console.error("Begin stroke failed:",o)}}),T.addEventListener("mousemove",h=>{if(!s)return;const u=ke(h);if(b=u,s.currentState==="drawing"&&A){const o=s.appendPoint(u);o&&p.renderPreview(o.nextSegments,o.brushPolygon2D??[],x),p.renderCursor(u,v,x);return}p.renderCommittedActive(s.getCurrentSegments()),p.renderCursor(u,v,x)}),window.addEventListener("mouseup",()=>{s&&A&&(A=!1,l())}),window.addEventListener("keydown",h=>{s&&h.key==="Escape"&&s.currentState==="drawing"&&(s.cancelStroke(),p.renderCommittedActive(s.getCurrentSegments()),Z(!1),A=!1)}),J(),await i()}Ht();
