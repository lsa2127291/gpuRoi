import{C as L,c as N,b as U,p as A,a as M,M as z,n as h}from"./index-DrIJp-T2.js";function D(){const n=new Float32Array([-50,-50,-50,50,-50,-50,50,50,-50,-50,50,-50,-50,-50,50,50,-50,50,50,50,50,-50,50,50]),e=new Uint32Array([0,2,1,0,3,2,4,5,6,4,6,7,0,1,5,0,5,4,2,3,7,2,7,6,0,4,7,0,7,3,1,2,6,1,6,5]),t=new Float32Array([-.577,-.577,-.577,.577,-.577,-.577,.577,.577,-.577,-.577,.577,-.577,-.577,-.577,.577,.577,-.577,.577,.577,.577,.577,-.577,.577,.577]);return{vertices:n,indices:e,normals:t}}class F{constructor(e){this.slicer=null,this.initPromise=null,this.camera=null,this.anchor=[0,0,0],this.lastResult=null,this.renderPending=!1,this.canvasRenderer=new L(e),this.initPromise=this.initSlicer()}get backend(){var e;return((e=this.slicer)==null?void 0:e.backend)??"pending"}async ready(){await this.initPromise}async setMesh(e){await this.initPromise,await this.slicer.init(e),await this.render()}async updateSlice(e,t){this.camera=e,this.anchor=t,await this.render()}async setRenderStyle(e,t,a){this.canvasRenderer.setStyle({color:e,lineWidth:t,scale:a}),await this.render()}getLastResult(){return this.lastResult}dispose(){var e;(e=this.slicer)==null||e.dispose(),this.slicer=null}async initSlicer(){this.slicer=await N()}async render(){if(!this.slicer||!this.camera){this.canvasRenderer.clear(),this.lastResult=null;return}if(!this.renderPending){this.renderPending=!0;try{const e=await this.slicer.slice(this.camera.viewPlaneNormal,this.anchor),t=U(this.camera.viewPlaneNormal,this.camera.viewUp),a=A(e,this.anchor,t,this.canvasRenderer.width,this.canvasRenderer.height,this.canvasRenderer.scale);this.lastResult={segments3D:e,segments2D:a},this.canvasRenderer.drawSegments(a)}finally{this.renderPending=!1}}}}const g=3,G=[.91,.27,.38,1],i=document.getElementById("canvas"),w=document.getElementById("slider"),V=document.getElementById("slider-value"),y=document.getElementById("backend-label"),v=document.getElementById("btn-axial"),b=document.getElementById("btn-sagittal"),p=document.getElementById("btn-coronal"),E=document.getElementById("btn-custom"),W=document.getElementById("custom-panel"),C=document.getElementById("nx"),I=document.getElementById("ny"),B=document.getElementById("nz"),P=document.getElementById("ux"),R=document.getElementById("uy"),S=document.getElementById("uz"),u=i.getContext("2d");if(!u)throw new Error("Failed to get 2D canvas context");let d="Axial",f=0;function O(){const n=h([Number(C.value)||0,Number(I.value)||0,Number(B.value)||0]),e=h([Number(P.value)||0,Number(R.value)||0,Number(S.value)||1]);return{viewPlaneNormal:n,viewUp:e}}function T(){return d==="Custom"?O():z[d]}function _(n,e){const t=n.viewPlaneNormal;return[-t[0]*e,-t[1]*e,-t[2]*e]}async function $(){const n=D(),e=await M();let t=null;if(e)y.textContent="åŽç«¯: ðŸŸ¢ GPU Bitmap (WebGPU)",await e.initBatch([n],[G]);else{t=new F(i),await t.ready();const s=t.backend==="gpu"?"ðŸŸ¢ GPU (WebGPU)":"ðŸ”µ CPU (Fallback)";y.textContent=`åŽç«¯: ${s}`,await t.setMesh(n),await t.setRenderStyle("#e94560",2,g)}async function a(){const s=++f,o=Number(w.value);V.textContent=`${o} mm`;const r=T(),m=_(r,o);if(e){try{const c=await e.sliceToBitmap(r.viewPlaneNormal,m,{viewUp:r.viewUp,width:i.width,height:i.height,scale:g});if(s!==f){c.close();return}u.clearRect(0,0,i.width,i.height),u.drawImage(c,0,0,i.width,i.height),c.close()}catch(c){console.error("Bitmap rendering failed:",c)}return}t&&await t.updateSlice(r,m)}const x=[v,b,p,E],k=["Axial","Sagittal","Coronal","Custom"];function l(s){d=s,x.forEach((o,r)=>{o.classList.toggle("active",k[r]===s)}),W.style.display=s==="Custom"?"flex":"none",a()}v.addEventListener("click",()=>l("Axial")),b.addEventListener("click",()=>l("Sagittal")),p.addEventListener("click",()=>l("Coronal")),E.addEventListener("click",()=>l("Custom")),w.addEventListener("input",()=>{a()});for(const s of[C,I,B,P,R,S])s.addEventListener("input",()=>{d==="Custom"&&a()});await a()}$();
