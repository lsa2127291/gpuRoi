import{C as Z,c as tt,e as et,M as nt,b as it,p as st}from"./index-77LIymxU.js";function J(a){let t=a|0;return()=>{t=t+1831565813|0;let e=Math.imul(t^t>>>15,1|t);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}function at(a,t=50,e=[0,0,0],m){const i=m!==void 0?J(m):Math.random,c=Math.max(4,Math.round(Math.sqrt(a))),r=c,o=c,d=(r+1)*(o+1),f=r*o*2,s=new Float32Array(d*3),h=new Float32Array(d*3),l=new Uint32Array(f*3),g=i()*1e3,P=t*.15;let w=0;for(let x=0;x<=r;x++){const M=Math.PI*x/r,S=Math.sin(M),I=Math.cos(M);for(let N=0;N<=o;N++){const _=2*Math.PI*N/o,V=S*Math.cos(_),G=S*Math.sin(_),W=I,Y=1+P/t*Math.sin(g+x*7.3+N*13.7),O=t*Y;s[w*3]=e[0]+V*O,s[w*3+1]=e[1]+G*O,s[w*3+2]=e[2]+W*O,h[w*3]=V,h[w*3+1]=G,h[w*3+2]=W,w++}}let T=0;for(let x=0;x<r;x++)for(let M=0;M<o;M++){const S=x*(o+1)+M,I=S+o+1;l[T++]=S,l[T++]=I,l[T++]=S+1,l[T++]=S+1,l[T++]=I,l[T++]=I+1}return{vertices:s,indices:l,normals:h}}function ot(a,t=2e4,e=1e6,m){const i=J(m),c=[];for(let r=0;r<a;r++){const o=Math.round(t+i()*(e-t)),d=30+i()*40,f=(i()-.5)*100,s=(i()-.5)*100,h=(i()-.5)*100,l=m+r*997;c.push(at(o,d,[f,s,h],l))}return c}const U=42,R=80,lt=document.getElementById("status"),k=document.getElementById("log"),u=document.getElementById("canvas-bitmap"),y=document.getElementById("canvas-segment"),$=document.getElementById("canvas-diff"),j=document.getElementById("slider"),ct=document.getElementById("slider-value"),H=document.getElementById("btn-generate"),A=document.getElementById("btn-run"),rt=document.getElementById("btn-axial"),dt=document.getElementById("btn-sagittal"),mt=document.getElementById("btn-coronal"),C=u.getContext("2d");if(!C)throw new Error("Failed to get bitmap canvas 2D context");const K=y.getContext("2d");if(!K)throw new Error("Failed to get segment canvas 2D context");const E=$.getContext("2d");if(!E)throw new Error("Failed to get diff canvas 2D context");const L=new Z(y,{color:"#e94560",lineWidth:1,scale:3}),q=16,z=.08;let v=null,B=null,p=[],Q=!1,F="Axial",b=0;function n(a,t=""){const e=document.createElement("span");t&&(e.className=t),e.textContent=a+`
`,k.appendChild(e),k.scrollTop=k.scrollHeight}function ht(){k.innerHTML=""}function X(a){const t=[...a].sort((m,i)=>m-i),e=t.reduce((m,i)=>m+i,0);return{total:e,avg:e/t.length,p50:t[Math.floor(t.length*.5)],p95:t[Math.floor(t.length*.95)],p99:t[Math.floor(t.length*.99)],min:t[0],max:t[t.length-1]}}function gt(a){const t=[];for(let e=0;e<a;e++){const i=(a<=1?0:e/a)*6,c=.8,r=.95,o=r*c,d=o*(1-Math.abs(i%2-1)),f=r-o;let s=0,h=0,l=0;i>=0&&i<1?(s=o,h=d):i>=1&&i<2?(s=d,h=o):i>=2&&i<3?(h=o,l=d):i>=3&&i<4?(h=d,l=o):i>=4&&i<5?(s=d,l=o):(s=o,l=d),t.push([s+f,h+f,l+f,1])}return t}function ft(){const a=Math.min(u.width,y.width,$.width),t=Math.min(u.height,y.height,$.height),e=C.getImageData(0,0,a,t).data,m=K.getImageData(0,0,a,t).data,i=E.createImageData(a,t),c=i.data;let r=0,o=0,d=0,f=0;for(let g=0;g<e.length;g+=4){const P=e[g+3]>q,w=m[g+3]>q;if((P||w)&&r++,P&&w){o++,c[g]=78,c[g+1]=205,c[g+2]=196,c[g+3]=180;continue}if(P){d++,c[g]=249,c[g+1]=168,c[g+2]=37,c[g+3]=220;continue}if(w){f++,c[g]=233,c[g+1]=69,c[g+2]=96,c[g+3]=220;continue}c[g+3]=0}E.clearRect(0,0,$.width,$.height),E.putImageData(i,0,0);const s=d+f,h=r>0?s/r:0,l=r>0?o/r:1;return{unionPixels:r,overlapPixels:o,onlyNewPixels:d,onlyOldPixels:f,diffPixels:s,diffRate:h,overlapRate:l}}async function ut(){v=await tt(),B=await et();const a=B?"ğŸŸ¢ å¯ç”¨":"ğŸ”´ ä¸å¯ç”¨";lt.textContent=`åç«¯: ${v.backend==="gpu"?"ğŸŸ¢ GPU":"ğŸ”µ CPU"} | æ‰¹é‡: ${a}`,n(`Slicer åˆå§‹åŒ–å®Œæˆï¼Œåç«¯: ${v.backend}ï¼Œæ‰¹é‡: ${a}`,"stat")}async function pt(){H.disabled=!0,ht(),n(`å¼€å§‹ç”Ÿæˆ ${R} ä¸ªéšæœº Meshï¼ˆseed=${U}ï¼‰...`);const a=performance.now();p=ot(R,2e4,38e4,U);const t=performance.now()-a;let e=0,m=0,i=1/0,c=0;for(const r of p){const o=r.vertices.length/3;e+=o,m+=r.indices.length/3,o<i&&(i=o),o>c&&(c=o)}if(n(`ç”Ÿæˆå®Œæˆï¼Œè€—æ—¶ ${t.toFixed(0)} ms`,"stat"),n(`  Mesh æ•°é‡: ${p.length}`),n(`  æ€»é¡¶ç‚¹æ•°: ${(e/1e6).toFixed(2)}M`),n(`  æ€»ä¸‰è§’å½¢æ•°: ${(m/1e6).toFixed(2)}M`),n(`  å• Mesh é¡¶ç‚¹èŒƒå›´: ${i} ~ ${c}`),n(`  å¹³å‡é¡¶ç‚¹æ•°: ${Math.round(e/p.length)}`),n(""),B){const r=performance.now(),o=gt(p.length);await B.initBatch(p,o),Q=!0,n(`Batch initBatch + 80è‰²è¡¨ è€—æ—¶: ${(performance.now()-r).toFixed(1)} ms`,"stat"),n("")}H.disabled=!1,A.disabled=!1}async function wt(a,t){if(!v)return{segments:[],initTime:0,sliceTime:0,timings:[]};const e=[],m=[];let i=0;for(let r=0;r<p.length;r++){const o=performance.now();await v.init(p[r]),i+=performance.now()-o;const d=performance.now(),f=await v.slice(a.viewPlaneNormal,t);m.push(performance.now()-d),e.push(...f)}const c=X(m);return{segments:e,initTime:i,sliceTime:c.total,timings:m}}async function xt(a,t){if(!B||!Q)return null;try{for(let c=0;c<2;c++)(await B.sliceToBitmap(a.viewPlaneNormal,t,{viewUp:a.viewUp,width:u.width,height:u.height,scale:L.scale})).close();const e=performance.now(),m=await B.sliceToBitmap(a.viewPlaneNormal,t,{viewUp:a.viewUp,width:u.width,height:u.height,scale:L.scale}),i=performance.now()-e;return{bitmap:m,initTime:0,sliceTime:i}}catch(e){return n(`âš  æ‰¹é‡ä½å›¾è·¯å¾„å¤±è´¥ï¼Œå›é€€åˆ°å• mesh: ${e}`,"err"),null}}async function vt(){if(!v||p.length===0)return;const a=++b;A.disabled=!0;const t=nt[F],e=Number(j.value),m=Bt(t,e);E.clearRect(0,0,$.width,$.height);try{n(`--- åˆ‡é¢æµ‹è¯•: ${F}, offset=${e}mm ---`),n(`
[Single] æ­£åœ¨é€ä¸ªæ‰§è¡Œ init + sliceï¼ˆ${p.length} meshesï¼‰...`);const i=wt(t,m).then(s=>{const h=X(s.timings),l=s.initTime+s.sliceTime;return a===b&&(n(`[Single] Init æ€»è€—æ—¶: ${s.initTime.toFixed(1)} ms`),n(`[Single] Slice æ€»è€—æ—¶: ${s.sliceTime.toFixed(1)} ms`,"stat"),n(`[Single] Slice P50: ${h.p50.toFixed(2)} ms`),n(`[Single] Slice P95: ${h.p95.toFixed(2)} ms`,"warn"),n(`[Single] Slice P99: ${h.p99.toFixed(2)} ms`,"warn"),n(`[Single] æ€»è€—æ—¶: ${l.toFixed(1)} ms`,"stat"),n(`[Single] çº¿æ®µæ•°: ${s.segments.length}`,"stat"),St(s.segments,t,m)),{singleResult:s,singleTimings:h,singleTotal:l}});let c;B?(n(`
[BatchBitmap] æ­£åœ¨æ‰§è¡Œæ‰¹é‡åˆ‡é¢ + GPUå¤šè‰²æ¸²æŸ“ï¼ˆ${p.length} meshesï¼‰...`),c=xt(t,m).then(s=>{if(a!==b)return s==null||s.bitmap.close(),s;if(s){const h=s.initTime+s.sliceTime;n(`[BatchBitmap] Init: ${s.initTime.toFixed(1)} ms`,"stat"),n(`[BatchBitmap] Slice+Render: ${s.sliceTime.toFixed(1)} ms`,"stat"),n(`[BatchBitmap] æ€»è€—æ—¶: ${h.toFixed(1)} ms`,"stat"),C.clearRect(0,0,u.width,u.height),C.drawImage(s.bitmap,0,0,u.width,u.height),s.bitmap.close(),n("Bitmap Canvas: drawImage è¾“å‡º 80 mesh å¤šè‰²åˆ‡é¢å›¾","stat")}else C.clearRect(0,0,u.width,u.height),n("Bitmap Canvas: æ— å¯ç”¨è¾“å‡ºï¼ˆbatch ä¸å¯ç”¨ï¼‰","warn");return s})):c=Promise.resolve(null);const[r,o]=await Promise.allSettled([i,c]);r.status==="rejected"&&n(`[Single] æ‰§è¡Œå¤±è´¥: ${r.reason}`,"err"),o.status==="rejected"&&n(`[BatchBitmap] æ‰§è¡Œå¤±è´¥: ${o.reason}`,"err");const d=r.status==="fulfilled"?r.value:null,f=o.status==="fulfilled"?o.value:null;if(a===b&&f&&d){const s=f.initTime+f.sliceTime,h=d.singleTotal/s,l=ft();n(""),n("=== å¯¹æ¯” ===","stat"),n(`  Single æ€»è€—æ—¶: ${d.singleTotal.toFixed(1)} ms`),n(`  BatchBitmap æ€»è€—æ—¶: ${s.toFixed(1)} ms`),n(`  åŠ é€Ÿæ¯”: ${h.toFixed(1)}x`,h>=2?"stat":"warn"),n(""),n("=== æ˜¾ç¤ºå·®å¼‚æ£€æµ‹ ===","stat"),n(`  é‡å åƒç´ : ${l.overlapPixels}`),n(`  ä»… New åƒç´ : ${l.onlyNewPixels}`),n(`  ä»… Old åƒç´ : ${l.onlyOldPixels}`),n(`  å·®å¼‚ç‡: ${(l.diffRate*100).toFixed(2)}%`,l.diffRate<=z?"stat":"warn"),n(`  é‡å ç‡(IoU): ${(l.overlapRate*100).toFixed(2)}%`,l.overlapRate>=1-z?"stat":"warn"),n("Diff Canvas: é’è‰²=é‡å ï¼Œæ©™è‰²=ä»… Newï¼Œçº¢è‰²=ä»… Old");const g={view:F,offset:e,seed:U,meshCount:R,single:{initMs:+d.singleResult.initTime.toFixed(1),sliceMs:+d.singleResult.sliceTime.toFixed(1),totalMs:+d.singleTotal.toFixed(1),segments:d.singleResult.segments.length,p50:+d.singleTimings.p50.toFixed(2),p95:+d.singleTimings.p95.toFixed(2),p99:+d.singleTimings.p99.toFixed(2)},batchBitmap:{initMs:+f.initTime.toFixed(1),totalMs:+s.toFixed(1)},displayDiff:{unionPixels:l.unionPixels,overlapPixels:l.overlapPixels,onlyNewPixels:l.onlyNewPixels,onlyOldPixels:l.onlyOldPixels,diffPixels:l.diffPixels,diffRate:+l.diffRate.toFixed(4),overlapRate:+l.overlapRate.toFixed(4)},speedup:+h.toFixed(1)};n(""),n(`JSON: ${JSON.stringify(g)}`)}}catch(i){n(`âš  è¿è¡Œå¤±è´¥: ${i}`,"err"),console.error("runBenchmark failed:",i)}finally{a===b&&(n(""),A.disabled=!1)}}function D(){!v||p.length===0||vt()}function Bt(a,t){const e=a.viewPlaneNormal;return[-e[0]*t,-e[1]*t,-e[2]*t]}function St(a,t,e){const m=it(t.viewPlaneNormal,t.viewUp),i=st(a,e,m,y.width,y.height,L.scale);L.drawSegments(i),n(`Segment Canvas: æ¸²æŸ“ ${i.length} æ¡ 2D çº¿æ®µ`,"stat")}H.addEventListener("click",pt);A.addEventListener("click",D);rt.addEventListener("click",()=>{F="Axial",D()});dt.addEventListener("click",()=>{F="Sagittal",D()});mt.addEventListener("click",()=>{F="Coronal",D()});j.addEventListener("change",()=>{ct.textContent=`${j.value} mm`,p.length>0&&D()});ut();
